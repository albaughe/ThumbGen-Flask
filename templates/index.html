<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Thumbnail Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Dark Theme Styling */
        body {
            background: #23272b !important;
            color: #f5f6fa !important;
        }
        
        .card {
            background: #2d3136 !important;
            border-radius: 0 !important;
            border: 1.5px solid #444 !important;
            color: #f5f6fa !important;
        }
        
        .section-card {
            background: #353940 !important;
            border-radius: 0 !important;
            border: 1.5px solid #444 !important;
            color: #f5f6fa !important;
        }
        
        .section-card {
            box-shadow: none;
            padding: 0.7rem 0.8rem 0.5rem 0.8rem;
            margin-bottom: 1.2rem;
        }
        
        /* Prevent horizontal scrolling in left panel */
        .slider-group {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 0;
            flex-wrap: wrap;
            min-height: 26px;
        }
        
        .slider-group input[type="range"] {
            min-width: 120px !important;
            flex: 1;
            max-width: none;
        }
        
        .slider-group input[type="number"] {
            min-width: 60px;
            width: 60px !important;
        }
        
        /* Force all content to stay within container */
        .section-card {
            overflow-x: hidden;
        }
        
        /* Make all form elements responsive */
        .form-control, .form-select {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure row and column layouts don't overflow */
        .row {
            margin-left: 0;
            margin-right: 0;
        }
        
        .col-4, .col-6 {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        
        .form-control, .form-select, .form-control-color, 
        textarea, input[type="number"], input[type="text"] {
            background: #40444b !important;
            color: #e0e2e6 !important;
            border: 1.5px solid #444 !important;
            border-radius: 0 !important;
            font-size: 13px;
            padding: 2px 6px !important;
            height: 26px !important;
            vertical-align: middle;
        }
        
        /* Slider styling - completely rewritten */
        input[type=range].form-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            background: transparent;
            outline: none;
            margin: 0 2px;
            vertical-align: middle;
        }
        
        input[type=range].form-range::-webkit-slider-track {
            width: 100%;
            height: 4px;
            background: #40444b;
            border-radius: 0;
            border: none;
        }
        
        input[type=range].form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #D73F09;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin-top: -4px;
        }
        
        input[type=range].form-range::-moz-range-track {
            width: 100%;
            height: 4px;
            background: #40444b;
            border-radius: 0;
            border: none;
        }
        
        input[type=range].form-range::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #D73F09;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin-top: -4px;
        }
        
        input[type=range].form-range::-ms-track {
            width: 100%;
            height: 4px;
            background: #40444b;
            border-radius: 0;
            border: none;
        }
        
        input[type=range].form-range::-ms-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #D73F09;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin-top: -4px;
        }
        
        /* Focus and Button Styles */
        .form-control:focus, .form-select:focus, textarea:focus, 
        input[type="number"]:focus, input[type="text"]:focus {
            background: #484c54 !important;
            color: #fff !important;
            border-color: #D73F09 !important;
            box-shadow: 0 0 0 1.5px #D73F0933 !important;
        }
        
        label, .form-label, .section-title, .small, .radio-group label {
            color: #d0d2d6 !important;
            font-size: 13px;
            line-height: 1.2;
        }
        
        .form-label {
            margin-bottom: 0.4rem;
            display: block;
        }
        
        .btn-primary {
            background: #D73F09 !important;
            border: none !important;
            color: #fff !important;
        }
        
        .btn-secondary, .reset-btn {
            background: #353940 !important;
            color: #f5f6fa !important;
            border: 1.5px solid #444 !important;
        }
        
        .btn-secondary:hover, .reset-btn:hover {
            background: #444 !important;
            color: #fff !important;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background: #23272b !important;
            border-bottom: 2px solid #444 !important;
        }
        
        .nav-tabs .nav-link {
            background: #353940 !important;
            color: #d0d2d6 !important;
            border: 1.5px solid #444 !important;
            border-bottom: none !important;
            border-radius: 0 !important;
            margin-right: 2px;
            font-size: 15px;
            font-weight: 500;
            padding: 0.4rem 1.2rem;
            transition: background 0.15s;
        }
        
        .nav-tabs .nav-link.active, .nav-tabs .nav-link:focus {
            background: #40444b !important;
            color: #fff !important;
            border-bottom: 2.5px solid #D73F09 !important;
            z-index: 2;
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            background: #353940cc !important;
            color: #fff !important;
        }
        
        .section-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.8rem;
            color: #d0d2d6;
            letter-spacing: 0.2px;
            text-decoration: underline;
            text-decoration-color: #D73F09;
            text-underline-offset: 4px;
            text-decoration-thickness: 2px;
        }
        
        .preview-image {
            background: #23272b !important;
            border: 1.5px solid #444 !important;
            border-radius: 0 !important;
        }
        
        .slider-group {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 0;
            min-height: 26px;
        }
        
        .reset-btn {
            border-radius: 0 !important;
            background: #353940 !important;
            color: #f5f6fa !important;
            border: 1.5px solid #444 !important;
            font-size: 14px;
            padding: 0 6px !important;
            height: 26px !important;
        }
        
        .preview-spinner {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid #444;
            border-top: 2px solid #D73F09;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .preview-spinner.active { opacity: 1; }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .filename-preview {
            background: #2d3136;
            border: 1.5px solid #444;
            border-radius: 0 !important;
            padding: 4px 8px;
            color: #d0d2d6;
        }
        

        
        /* Ensure proper alignment for form elements */
        .form-label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 2px;
        }
        
        /* Prevent sliders from becoming too small */
        .slider-group input[type="range"] {
            min-width: 120px !important;
            max-width: none;
        }
        
        /* Ensure consistent height for all form elements */
        .form-control, .form-select, input[type="range"] {
            box-sizing: border-box;
        }

        /* New styles for alignment grid */
        .alignment-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
            max-width: 80px;
            margin: 0 auto;
        }

        .alignment-row {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .alignment-option {
            cursor: pointer;
        }

        .alignment-option input[type="radio"] {
            display: none; /* Hide default radio button */
        }

        .alignment-box {
            width: 18px;
            height: 18px;
            border: 1px solid #444;
            border-radius: 2px;
            background: #6c757d; /* Light grey for unchecked */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .alignment-option input[type="radio"]:checked + .alignment-box {
            background: #D73F09;
            border-color: #D73F09;
        }

        .alignment-option:hover .alignment-box {
            background: #8a8d91; /* Lighter grey on hover */
        }

        /* Custom Dropdown Styling */
        .custom-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-header {
            background: #40444b;
            border: 1.5px solid #444;
            border-radius: 0;
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: #e0e2e6;
            transition: border-color 0.15s ease;
        }

        .dropdown-header:hover {
            border-color: #D73F09;
        }

        .dropdown-arrow {
            font-size: 10px;
            color: #d0d2d6;
            transition: transform 0.15s ease;
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: fixed;
            background: #40444b;
            border: 1.5px solid #444;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            min-width: 200px;
        }

        .dropdown-option {
            padding: 6px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #e0e2e6;
            transition: background 0.15s ease;
        }

        .dropdown-option:hover {
            background: #484c54;
        }

        .dropdown-option.selected {
            background: #D73F09;
            color: #fff;
        }


    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Thumbnail Generator</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row h-100 min-vh-80 justify-content-center">
            <!-- Settings Panel -->
            <div class="col-auto d-flex flex-column" style="width: 35vw; min-width:500px; max-width:45vw;">
                <div class="card p-2" style="overflow-y:auto; height:fit-content; max-height:92vh;">
                    <form id="settings-form">
                        <!-- TEXT FIELD SECTION (moved to top) -->
                        <div class="section-card">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="section-title mb-0">Thumbnail Text</div>
                                <button type="button" id="reset-all-btn" class="btn btn-secondary btn-sm ms-2">Reset All</button>
                                            </div>
                                <label class="form-label">Text to Display (use ^ for number in batch mode):</label>
                                <textarea class="form-control form-control-sm" name="text" id="text" rows="2">Week ^ Overview</textarea>
                                </div>
                        <!-- Font & Size and Text Color Sections Side by Side -->
                        <div class="section-card">
                            <div class="row g-2 align-items-stretch">
                                <!-- Font & Size (Left) -->
                                <div class="col-6 pe-4" style="border-right: 2px solid #444;">
                            <div class="section-title">Font & Size</div>
                                <div class="mb-2">
                                        <label class="form-label mb-0">Font:</label>
                                        <select name="font_name" class="form-select form-select-sm">
                                            {% for font in fonts %}
                                            <option value="{{ font }}">{{ font }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-2">
                                        <label class="form-label mb-0">Font Size:</label>
                                    <div class="slider-group" data-default="100">
                                            <input type="range" name="font_size" min="10" max="200" value="100" class="form-range">
                                            <input type="number" min="1" max="500" value="100" class="form-control form-control-sm w-70px">
                                        <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                    </div>
                                </div>
                                </div>
                                <!-- Text Color (Right) -->
                                <div class="col-6 ps-4">
                                    <div class="section-title">Text Color</div>
                                    
                                    <!-- Branded Colors Dropdown -->
                                <div class="mb-2">
                                    <label class="form-label mb-0">Branded Colors:</label>
                                    <div class="custom-dropdown">
                                        <div class="dropdown-header" id="text-branded-dropdown-header">
                                            <span id="text-branded-text">Bucktooth White</span>
                                            <span class="dropdown-arrow">▼</span>
                                        </div>
                                        <div class="dropdown-options" id="text-branded-options" style="display: none;">
                                            <div class="dropdown-option" data-color="#FFFFFF" data-name="Bucktooth White">
                                                <div class="color-swatch" style="background: #FFFFFF; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Bucktooth White</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#000000" data-name="Paddletail Black">
                                                <div class="color-swatch" style="background: #000000; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Paddletail Black</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#D73F09" data-name="Beaver Orange">
                                                <div class="color-swatch" style="background: #D73F09; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Beaver Orange</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#4A773C" data-name="Pine Stand">
                                                <div class="color-swatch" style="background: #4A773C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Pine Stand</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#00859B" data-name="High Tide">
                                                <div class="color-swatch" style="background: #00859B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>High Tide</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#FFB500" data-name="Luminance">
                                                <div class="color-swatch" style="background: #FFB500; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Luminance</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#006A8E" data-name="Stratosphere">
                                                <div class="color-swatch" style="background: #006A8E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Stratosphere</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#C4D6A4" data-name="Reindeer Moss">
                                                <div class="color-swatch" style="background: #C4D6A4; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Reindeer Moss</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#B8DDE1" data-name="Seafoam">
                                                <div class="color-swatch" style="background: #B8DDE1; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Seafoam</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#FDD26E" data-name="Candela">
                                                <div class="color-swatch" style="background: #FDD26E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Candela</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#C6DAE7" data-name="Moondust">
                                                <div class="color-swatch" style="background: #C6DAE7; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Moondust</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#AA9D2E" data-name="Hop Bine">
                                                <div class="color-swatch" style="background: #AA9D2E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Hop Bine</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#0D5257" data-name="Rogue Wave">
                                                <div class="color-swatch" style="background: #0D5257; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Rogue Wave</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#D3832B" data-name="Solar Flare">
                                                <div class="color-swatch" style="background: #D3832B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Solar Flare</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#003B5C" data-name="Star Canvas">
                                                <div class="color-swatch" style="background: #003B5C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Star Canvas</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#B7A99A" data-name="Till">
                                                <div class="color-swatch" style="background: #B7A99A; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Till</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#A7ACA2" data-name="Coastline">
                                                <div class="color-swatch" style="background: #A7ACA2; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Coastline</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#7A6855" data-name="High Desert">
                                                <div class="color-swatch" style="background: #7A6855; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>High Desert</span>
                                            </div>
                                            <div class="dropdown-option" data-color="#8E9089" data-name="Crater">
                                                <div class="color-swatch" style="background: #8E9089; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Crater</span>
                                            </div>
                                            <div class="dropdown-option" data-color="custom" data-name="Custom">
                                                <div class="color-swatch" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 4px 4px; background-position: 0 0, 0 2px, 2px -2px, -2px 0px; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                <span>Custom Color</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hex Code Input -->
                                <div class="mb-2">
                                    <label class="form-label mb-0">Hex Code:</label>
                                    <input type="text" id="text-hex-input" class="form-control form-control-sm" placeholder="#FFFFFF" value="#FFFFFF" maxlength="7">
                                </div>
                                    
                                    <div class="mb-2 d-flex align-items-center">
                                        <input type="color" name="text_color" value="#FFFFFF" class="form-control form-control-color">
                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                        <!-- Text Position & Spacing Section -->
                        <div class="section-card" style="margin-top: 1.5rem;">
                            <div class="section-title">Text Position & Spacing</div>
                            
                            <!-- Position Controls -->
                            <div class="mb-3">
                                <!-- Position Sliders -->
                                <div class="row g-2">
                                    <div class="col-8">
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Horizontal Position:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="text_x_offset" id="text_x_offset" min="-900" max="900" value="0" class="form-range">
                                                <input type="number" min="-900" max="900" value="0" class="form-control form-control-sm w-70px">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                </div>
                            </div>
                                    <div class="mb-2">
                                            <label class="form-label mb-0">Vertical Position:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="text_y_offset" id="text_y_offset" min="-900" max="900" value="0" class="form-range">
                                                <input type="number" min="-900" max="900" value="0" class="form-control form-control-sm w-70px">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label mb-0">Text Alignment:</label>
                                        <div class="alignment-grid">
                                            <div class="alignment-row">
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="top_left">
                                                    <div class="alignment-box"></div>
                                            </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="top_center">
                                                    <div class="alignment-box"></div>
                                            </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="top_right">
                                                    <div class="alignment-box"></div>
                                            </label>
                                        </div>
                                            <div class="alignment-row">
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="left">
                                                    <div class="alignment-box"></div>
                                                </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="center" checked>
                                                    <div class="alignment-box"></div>
                                                </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="right">
                                                    <div class="alignment-box"></div>
                                                </label>
                                    </div>
                                            <div class="alignment-row">
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="bottom_left">
                                                    <div class="alignment-box"></div>
                                                </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="bottom_center">
                                                    <div class="alignment-box"></div>
                                                </label>
                                                <label class="alignment-option">
                                                    <input type="radio" name="text_alignment" value="bottom_right">
                                                    <div class="alignment-box"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Spacing Controls -->
                            <div class="row g-2">
                                <div class="col-6">
                                                                <div class="mb-2">
                                <label class="form-label mb-0">Text Margins:</label>
                                    <div class="slider-group" data-default="100">
                                            <input type="range" name="text_margins" min="10" max="200" value="100" class="form-range">
                                            <input type="number" min="0" max="500" value="100" class="form-control form-control-sm w-70px">
                                        <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                    </div>
                                </div>
                            </div>
                                <div class="col-6">
                            <div class="mb-2">
                                <label class="form-label mb-0">Line Spacing:</label>
                                    <div class="slider-group" data-default="30">
                                            <input type="range" name="line_spacing_factor" min="0" max="100" value="30" class="form-range">
                                            <input type="number" min="0" max="300" value="30" class="form-control form-control-sm w-70px">
                                        <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                </div>
                            </div>
                                </div>
                            </div>
                        </div>

                        <!-- Text Effects Section -->
                        <div class="section-card" style="margin-top: 1.5rem;">
                            <div class="section-title">Text Effects</div>
                            
                            <!-- Stroke Toggle -->
                            <div class="mb-2 d-flex align-items-center gap-2">
                                <input type="checkbox" name="text_stroke_enabled" id="text_stroke_enabled">
                                <label for="text_stroke_enabled" class="mb-0 small">Enable Stroke</label>
                            </div>
                            
                            <!-- Stroke Controls (initially hidden) -->
                            <div id="stroke_controls" style="display: none;">
                                <div class="mb-2">
                                    <div class="row g-2">
                                        <!-- Stroke Color -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Stroke Color:</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="custom-dropdown">
                                                        <div class="dropdown-header" id="stroke-branded-dropdown-header">
                                                            <span id="stroke-branded-text">Paddletail Black</span>
                                                            <span class="dropdown-arrow">▼</span>
                                                        </div>
                                                        <div class="dropdown-options" id="stroke-branded-options" style="display: none;">
                                                            <div class="dropdown-option" data-color="#FFFFFF" data-name="Bucktooth White">
                                                                <div class="color-swatch" style="background: #FFFFFF; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Bucktooth White</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#000000" data-name="Paddletail Black">
                                                                <div class="color-swatch" style="background: #000000; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Paddletail Black</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#D73F09" data-name="Beaver Orange">
                                                                <div class="color-swatch" style="background: #D73F09; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Beaver Orange</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#4A773C" data-name="Pine Stand">
                                                                <div class="color-swatch" style="background: #4A773C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Pine Stand</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#00859B" data-name="High Tide">
                                                                <div class="color-swatch" style="background: #00859B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>High Tide</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#FFB500" data-name="Luminance">
                                                                <div class="color-swatch" style="background: #FFB500; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Luminance</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#006A8E" data-name="Stratosphere">
                                                                <div class="color-swatch" style="background: #006A8E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Stratosphere</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#C4D6A4" data-name="Reindeer Moss">
                                                                <div class="color-swatch" style="background: #C4D6A4; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Reindeer Moss</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#B8DDE1" data-name="Seafoam">
                                                                <div class="color-swatch" style="background: #B8DDE1; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Seafoam</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#FDD26E" data-name="Candela">
                                                                <div class="color-swatch" style="background: #FDD26E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Candela</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#C6DAE7" data-name="Moondust">
                                                                <div class="color-swatch" style="background: #C6DAE7; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Moondust</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#AA9D2E" data-name="Hop Bine">
                                                                <div class="color-swatch" style="background: #AA9D2E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Hop Bine</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#0D5257" data-name="Rogue Wave">
                                                                <div class="color-swatch" style="background: #0D5257; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Rogue Wave</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#D3832B" data-name="Solar Flare">
                                                                <div class="color-swatch" style="background: #D3832B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Solar Flare</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#003B5C" data-name="Star Canvas">
                                                                <div class="color-swatch" style="background: #003B5C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Star Canvas</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#B7A99A" data-name="Till">
                                                                <div class="color-swatch" style="background: #B7A99A; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Till</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#A7ACA2" data-name="Coastline">
                                                                <div class="color-swatch" style="background: #A7ACA2; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Coastline</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#7A6855" data-name="High Desert">
                                                                <div class="color-swatch" style="background: #7A6855; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>High Desert</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#8E9089" data-name="Crater">
                                                                <div class="color-swatch" style="background: #8E9089; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Crater</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="custom" data-name="Custom">
                                                                <div class="color-swatch" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 4px 4px; background-position: 0 0, 0 2px, 2px -2px, -2px 0px; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Custom Color</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <input type="text" id="stroke-hex-input" class="form-control form-control-sm" placeholder="#000000" value="#000000" maxlength="7">
                                                </div>
                                                <div class="col-2">
                                                    <input type="color" name="text_stroke_color" value="#000000" class="form-control form-control-color">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Stroke Width -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Width:</label>
                                            <div class="slider-group" data-default="2">
                                                <input type="range" name="text_stroke_width" min="1" max="10" 
                                                       value="2" class="form-range w-100">
                                                <input type="number" min="1" max="30" value="2" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Background Box Toggle -->
                            <div class="mb-2 d-flex align-items-center gap-2">
                                <input type="checkbox" name="text_box_enabled" id="text_box_enabled">
                                <label for="text_box_enabled" class="mb-0 small">Background Box</label>
                            </div>
                            
                            <!-- Background Box Controls (initially hidden) -->
                            <div id="background_box_controls" style="display: none;">
                                <div class="mb-2">
                                    <div class="row g-2">
                                        <!-- Box Color -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Box Color:</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="custom-dropdown">
                                                        <div class="dropdown-header" id="box-branded-dropdown-header">
                                                            <span id="box-branded-text">Dark Gray</span>
                                                            <span class="dropdown-arrow">▼</span>
                                                        </div>
                                                        <div class="dropdown-options" id="box-branded-options" style="display: none;">
                                                            <div class="dropdown-option" data-color="#FFFFFF" data-name="Bucktooth White">
                                                                <div class="color-swatch" style="background: #FFFFFF; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Bucktooth White</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#000000" data-name="Paddletail Black">
                                                                <div class="color-swatch" style="background: #000000; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Paddletail Black</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#D73F09" data-name="Beaver Orange">
                                                                <div class="color-swatch" style="background: #D73F09; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Beaver Orange</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#4A773C" data-name="Pine Stand">
                                                                <div class="color-swatch" style="background: #4A773C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Pine Stand</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#00859B" data-name="High Tide">
                                                                <div class="color-swatch" style="background: #00859B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>High Tide</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#FFB500" data-name="Luminance">
                                                                <div class="color-swatch" style="background: #FFB500; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Luminance</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#006A8E" data-name="Stratosphere">
                                                                <div class="color-swatch" style="background: #006A8E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Stratosphere</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#C4D6A4" data-name="Reindeer Moss">
                                                                <div class="color-swatch" style="background: #C4D6A4; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Reindeer Moss</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#B8DDE1" data-name="Seafoam">
                                                                <div class="color-swatch" style="background: #B8DDE1; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Seafoam</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#FDD26E" data-name="Candela">
                                                                <div class="color-swatch" style="background: #FDD26E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Candela</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#C6DAE7" data-name="Moondust">
                                                                <div class="color-swatch" style="background: #C6DAE7; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Moondust</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#AA9D2E" data-name="Hop Bine">
                                                                <div class="color-swatch" style="background: #AA9D2E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Hop Bine</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#0D5257" data-name="Rogue Wave">
                                                                <div class="color-swatch" style="background: #0D5257; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Rogue Wave</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#D3832B" data-name="Solar Flare">
                                                                <div class="color-swatch" style="background: #D3832B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Solar Flare</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#003B5C" data-name="Star Canvas">
                                                                <div class="color-swatch" style="background: #003B5C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Star Canvas</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#B7A99A" data-name="Till">
                                                                <div class="color-swatch" style="background: #B7A99A; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Till</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#A7ACA2" data-name="Coastline">
                                                                <div class="color-swatch" style="background: #A7ACA2; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Coastline</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#7A6855" data-name="High Desert">
                                                                <div class="color-swatch" style="background: #7A6855; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>High Desert</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="#8E9089" data-name="Crater">
                                                                <div class="color-swatch" style="background: #8E9089; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Crater</span>
                                                            </div>
                                                            <div class="dropdown-option" data-color="custom" data-name="Custom">
                                                                <div class="color-swatch" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 4px 4px; background-position: 0 0, 0 2px, 2px -2px, -2px 0px; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                                <span>Custom Color</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <input type="text" id="box-hex-input" class="form-control form-control-sm" placeholder="#23272b" value="#23272b" maxlength="7">
                                                </div>
                                                <div class="col-2">
                                                    <input type="color" name="text_box_color" value="#23272b" class="form-control form-control-color">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Box Padding -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Padding:</label>
                                            <div class="slider-group" data-default="20">
                                                <input type="range" name="text_box_padding" min="5" max="50" 
                                                       value="20" class="form-range w-100">
                                                <input type="number" min="0" max="200" value="20" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Box Opacity -->
                                        <div class="mb-2">
                                            <label class="form-label mb-0">Opacity:</label>
                                            <div class="slider-group" data-default="100">
                                                <input type="range" name="text_box_opacity" min="0" max="100" 
                                                       value="100" class="form-range w-100">
                                                <input type="number" min="0" max="255" value="100" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Background & Pattern Section -->
                        <div class="section-card" style="margin-top: 1.5rem;">
                            <div class="section-title">Background & Pattern</div>
                            <div class="mb-2">
                                <label class="form-label mb-0">Background Color:</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="custom-dropdown">
                                            <div class="dropdown-header" id="bg-branded-dropdown-header">
                                                <span id="bg-branded-text">Beaver Orange</span>
                                                <span class="dropdown-arrow">▼</span>
                                            </div>
                                            <div class="dropdown-options" id="bg-branded-options" style="display: none;">
                                                <div class="dropdown-option" data-color="#FFFFFF" data-name="Bucktooth White">
                                                    <div class="color-swatch" style="background: #FFFFFF; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Bucktooth White</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#000000" data-name="Paddletail Black">
                                                    <div class="color-swatch" style="background: #000000; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Paddletail Black</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#D73F09" data-name="Beaver Orange">
                                                    <div class="color-swatch" style="background: #D73F09; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Beaver Orange</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#4A773C" data-name="Pine Stand">
                                                    <div class="color-swatch" style="background: #4A773C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Pine Stand</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#00859B" data-name="High Tide">
                                                    <div class="color-swatch" style="background: #00859B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>High Tide</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#FFB500" data-name="Luminance">
                                                    <div class="color-swatch" style="background: #FFB500; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Luminance</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#006A8E" data-name="Stratosphere">
                                                    <div class="color-swatch" style="background: #006A8E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Stratosphere</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#C4D6A4" data-name="Reindeer Moss">
                                                    <div class="color-swatch" style="background: #C4D6A4; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Reindeer Moss</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#B8DDE1" data-name="Seafoam">
                                                    <div class="color-swatch" style="background: #B8DDE1; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Seafoam</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#FDD26E" data-name="Candela">
                                                    <div class="color-swatch" style="background: #FDD26E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Candela</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#C6DAE7" data-name="Moondust">
                                                    <div class="color-swatch" style="background: #C6DAE7; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Moondust</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#AA9D2E" data-name="Hop Bine">
                                                    <div class="color-swatch" style="background: #AA9D2E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Hop Bine</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#0D5257" data-name="Rogue Wave">
                                                    <div class="color-swatch" style="background: #0D5257; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Rogue Wave</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#D3832B" data-name="Solar Flare">
                                                    <div class="color-swatch" style="background: #D3832B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Solar Flare</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#003B5C" data-name="Star Canvas">
                                                    <div class="color-swatch" style="background: #003B5C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Star Canvas</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#B7A99A" data-name="Till">
                                                    <div class="color-swatch" style="background: #B7A99A; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Till</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#A7ACA2" data-name="Coastline">
                                                    <div class="color-swatch" style="background: #A7ACA2; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Coastline</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#7A6855" data-name="High Desert">
                                                    <div class="color-swatch" style="background: #7A6855; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>High Desert</span>
                                                </div>
                                                <div class="dropdown-option" data-color="#8E9089" data-name="Crater">
                                                    <div class="color-swatch" style="background: #8E9089; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Crater</span>
                                                </div>
                                                <div class="dropdown-option" data-color="custom" data-name="Custom">
                                                    <div class="color-swatch" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 4px 4px; background-position: 0 0, 0 2px, 2px -2px, -2px 0px; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                    <span>Custom Color</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <input type="text" id="bg-hex-input" class="form-control form-control-sm" placeholder="#D73F09" value="#D73F09" maxlength="7">
                                    </div>
                                    <div class="col-2">
                                        <input type="color" name="background_color" value="#d73f09" class="form-control form-control-color">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Background Image Toggle -->
                            <div class="mb-2 d-flex align-items-center gap-2">
                                <input type="checkbox" name="background_image_enabled" id="background_image_enabled">
                                <label for="background_image_enabled" class="mb-0 small">Enable Background Image</label>
                                    </div>
                            
                            <!-- Background Image Controls (initially hidden) -->
                            <div id="background_image_controls" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label">Background Image:</label>
                                    <select name="background_image" class="form-select form-select-sm">
                                        {% for bg in backgrounds %}
                                        <option value="{{ bg }}">{{ bg }}</option>
                                        {% endfor %}
                                    </select>
                                    </div>
                                <div class="mb-2">
                                    <label class="form-label mb-0">Opacity:</label>
                                    <div class="slider-group" data-default="100">
                                        <input type="range" name="background_opacity" min="0" max="100" 
                                               value="100" class="form-range w-60px">
                                        <input type="number" min="0" max="100" value="100" 
                                               class="form-control form-control-sm w-60px">
                                        <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <label class="form-label mb-0">Scale:</label>
                                            <div class="slider-group" data-default="100">
                                                <input type="range" name="bg_image_scale" min="10" max="200" 
                                                       value="100" class="form-range w-100">
                                                <input type="number" min="10" max="500" value="100" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label mb-0">X Offset:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="bg_image_x_offset" min="-200" max="200" 
                                                       value="0" class="form-range w-100">
                                                <input type="number" min="-500" max="500" value="0" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label mb-0">Y Offset:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="bg_image_y_offset" min="-200" max="200" 
                                                       value="0" class="form-range w-100">
                                                <input type="number" min="-500" max="500" value="0" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pattern Toggle -->
                            <div class="mb-2 d-flex align-items-center gap-2">
                                <input type="checkbox" name="pattern_enabled" id="pattern_enabled">
                                <label for="pattern_enabled" class="mb-0 small">Enable Pattern Overlay</label>
                            </div>
                            
                            <!-- Pattern Controls (initially hidden) -->
                            <div id="pattern_controls" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label">Pattern:</label>
                                    <select name="pattern_overlay" class="form-select form-select-sm">
                                        {% for pattern in patterns %}
                                        <option value="{{ pattern }}">{{ pattern }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
                                    <input type="checkbox" name="pattern_color_enabled" id="pattern_color_enabled">
                                    <label for="pattern_color_enabled" class="mb-0 small">Color Tint</label>
                                    <div class="color-section mb-2">
                                        <label class="form-label mb-0">Pattern Color:</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <div class="custom-dropdown">
                                                    <div class="dropdown-header" id="pattern-branded-dropdown-header">
                                                        <span id="pattern-branded-text">Bucktooth White</span>
                                                        <span class="dropdown-arrow">▼</span>
                                                    </div>
                                                    <div class="dropdown-options" id="pattern-branded-options" style="display: none;">
                                                        <div class="dropdown-option" data-color="#FFFFFF" data-name="Bucktooth White">
                                                            <div class="color-swatch" style="background: #FFFFFF; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Bucktooth White</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#000000" data-name="Paddletail Black">
                                                            <div class="color-swatch" style="background: #000000; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Paddletail Black</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#D73F09" data-name="Beaver Orange">
                                                            <div class="color-swatch" style="background: #D73F09; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Beaver Orange</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#4A773C" data-name="Pine Stand">
                                                            <div class="color-swatch" style="background: #4A773C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Pine Stand</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#00859B" data-name="High Tide">
                                                            <div class="color-swatch" style="background: #00859B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>High Tide</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#FFB500" data-name="Luminance">
                                                            <div class="color-swatch" style="background: #FFB500; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Luminance</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#006A8E" data-name="Stratosphere">
                                                            <div class="color-swatch" style="background: #006A8E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Stratosphere</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#C4D6A4" data-name="Reindeer Moss">
                                                            <div class="color-swatch" style="background: #C4D6A4; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Reindeer Moss</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#B8DDE1" data-name="Seafoam">
                                                            <div class="color-swatch" style="background: #B8DDE1; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Seafoam</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#FDD26E" data-name="Candela">
                                                            <div class="color-swatch" style="background: #FDD26E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Candela</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#C6DAE7" data-name="Moondust">
                                                            <div class="color-swatch" style="background: #C6DAE7; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Moondust</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#AA9D2E" data-name="Hop Bine">
                                                            <div class="color-swatch" style="background: #AA9D2E; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Hop Bine</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#0D5257" data-name="Rogue Wave">
                                                            <div class="color-swatch" style="background: #0D5257; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Rogue Wave</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#D3832B" data-name="Solar Flare">
                                                            <div class="color-swatch" style="background: #D3832B; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Solar Flare</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#003B5C" data-name="Star Canvas">
                                                            <div class="color-swatch" style="background: #003B5C; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Star Canvas</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#B7A99A" data-name="Till">
                                                            <div class="color-swatch" style="background: #B7A99A; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Till</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#A7ACA2" data-name="Coastline">
                                                            <div class="color-swatch" style="background: #A7ACA2; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Coastline</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#7A6855" data-name="High Desert">
                                                            <div class="color-swatch" style="background: #7A6855; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>High Desert</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="#8E9089" data-name="Crater">
                                                            <div class="color-swatch" style="background: #8E9089; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Crater</span>
                                                        </div>
                                                        <div class="dropdown-option" data-color="custom" data-name="Custom">
                                                            <div class="color-swatch" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 4px 4px; background-position: 0 0, 0 2px, 2px -2px, -2px 0px; width: 16px; height: 16px; border: 1px solid #444; border-radius: 2px; display: inline-block; margin-right: 8px;"></div>
                                                            <span>Custom Color</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <input type="text" id="pattern-hex-input" class="form-control form-control-sm" placeholder="#ffffff" value="#ffffff" maxlength="7">
                                            </div>
                                            <div class="col-2">
                                                <input type="color" name="pattern_color" value="#ffffff" class="form-control form-control-color">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-2 align-items-center">
                                        <div class="col-auto">
                                            <label class="form-label mb-0">Opacity:</label>
                                        </div>
                                        <div class="col">
                                            <div class="slider-group" data-default="100">
                                                <input type="range" name="pattern_opacity" min="0" max="100" 
                                                       value="100" class="form-range w-60px">
                                                <input type="number" min="0" max="100" value="100" 
                                                       class="form-control form-control-sm w-60px">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <label class="form-label mb-0">Scale:</label>
                                            <div class="slider-group" data-default="40">
                                                <input type="range" name="pattern_scale" min="10" max="500" 
                                                       value="40" class="form-range w-100">
                                                <input type="number" min="10" max="1000" value="40" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label mb-0">X Offset:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="pattern_x_offset" min="-900" max="900" 
                                                       value="0" class="form-range w-100">
                                                <input type="number" min="-1000" max="1000" value="0" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label mb-0">Y Offset:</label>
                                            <div class="slider-group" data-default="0">
                                                <input type="range" name="pattern_y_offset" min="-900" max="900" 
                                                       value="0" class="form-range w-100">
                                                <input type="number" min="-1000" max="1000" value="0" 
                                                       class="form-control form-control-sm w-100">
                                                <button type="button" class="reset-btn btn btn-secondary btn-sm px-2 py-0">↺</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Preview Panel -->
        <div class="col-auto d-flex flex-column position-relative" style="width: 35vw; min-width:500px; max-width:45vw;">
                <div class="card p-2 d-flex flex-column align-items-center justify-content-start" 
                     style="width: 100%; max-width: 98vw; margin: 0 auto;">
                    <h5 class="mb-3" style="align-self: flex-start; text-decoration: underline; text-decoration-color: #D73F09; text-underline-offset: 4px; text-decoration-thickness: 2px;">Preview</h5>
                    <div class="preview-image position-relative d-flex align-items-center justify-content-center mb-2" 
                         id="preview-container" 
                         style="overflow: hidden; aspect-ratio: 16/9; width: 100%; max-width: 100%;">
                        <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                            <img id="preview-img" style="display: none; width: 100%; height: 100%; object-fit: contain;">
            
                            <p id="preview-text" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); margin: 0;">
                                Loading preview...
                            </p>
                            <div class="preview-spinner" id="preview-spinner"></div>
                        </div>
                    </div>
                <!-- Contrast Checker Panel: Inserted directly after preview window -->
                <div id="contrast-checker-panel" class="section-card mt-3 mb-3" style="max-width: 420px; margin: 0 auto;">
                    <div class="section-title mb-2" style="font-size: 1rem;">Contrast Checker</div>
                    <div class="d-flex flex-column" style="gap: 6px;">
                        <div class="d-flex align-items-center mb-1">
                          <span style="min-width: 90px; font-size: 11px;">Text Color:</span>
                          <span id="contrast-text-swatch" style="display:inline-block;width:22px;height:22px;border:1.5px solid #444;border-radius:3px;margin-right:8px;"></span>
                          <span id="contrast-text-hex" style="font-family:monospace;font-size:13px;"></span>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                          <span style="min-width: 90px; font-size: 11px;">Background: </span>
                          <span id="contrast-bg-swatch" style="display:inline-block;width:22px;height:22px;border:1.5px solid #444;border-radius:3px;margin-right:8px;"></span>
                          <span id="contrast-bg-hex" style="font-family:monospace;font-size:13px;"></span>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                          <span style="min-width: 90px; font-size: 11px;">Contrast Ratio:</span>
                          <span id="contrast-ratio" style="font-weight:bold;font-size:15px;margin-left:8px;"></span>
                        </div>
                        <div id="contrast-status" style="font-size:13px;"></div>
                        </div>
                    </div>
                    
                <!-- File & Text Settings (moved back under preview) -->
                    <div class="w-100 mb-2">
                        <div class="section-card">
                            <div class="section-title">File & Text</div>
                            <div class="mb-2">
                                <label class="form-label">File Name:</label>
                                <input type="text" class="form-control form-control-sm" 
                                       name="filename_base" id="filename_base" value="Thumbnail">
                            </div>
                            
                            <!-- Batch Mode Toggle -->
                            <div class="mb-2 d-flex align-items-center gap-2">
                                <input type="checkbox" name="batch_mode" id="batch_mode">
                                <label for="batch_mode" class="mb-0 small">Batch Mode</label>
                            </div>
                            
                            <!-- Batch Controls (initially hidden) -->
                            <div id="batch_controls" style="display: none;">
                                <div class="mb-2 d-flex align-items-center gap-2">
                                    <div class="flex-1">
                                        <label class="form-label">Start Number:</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="start_number" id="start_number" min="1" max="1000" 
                                               value="1" class="w-80px">
                                    </div>
                                    <div class="flex-1">
                                        <label class="form-label">Number of Files:</label>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="batch_count" id="batch_count" min="1" max="100" 
                                               value="1" class="w-80px">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <h6 class="mb-1 small">Output Filenames</h6>
                                    <div class="filename-preview" id="filename-preview" style="font-size:12px;">
                                        Files will appear here...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="w-100 mb-1">
                        <button type="button" class="btn btn-primary w-100 btn-sm" id="download-btn">
                            Download PNG
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function setupToggleControl(checkboxId, controlsId, selectName) {
            const checkbox = document.getElementById(checkboxId);
            const controls = document.getElementById(controlsId);
            const select = document.querySelector(`[name="${selectName}"]`);
            if (checkbox && controls) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        controls.style.display = 'block';
                        if (select && select.options.length > 0) {
                            select.selectedIndex = 0;
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        controls.style.display = 'none';
                    }
                    scheduleUpdate(50);
                });
            }
        }

        function setupToggleControls() {
            // Background Image Toggle (with auto-selection)
            const bgImageCheckbox = document.getElementById('background_image_enabled');
            const bgImageControls = document.getElementById('background_image_controls');
            const bgImageSelect = document.querySelector('[name="background_image"]');
            
            if (bgImageCheckbox && bgImageControls) {
                bgImageCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        bgImageControls.style.display = 'block';
                        // Auto-select first background if available
                        if (bgImageSelect && bgImageSelect.options.length > 0) {
                            bgImageSelect.selectedIndex = 0;
                            bgImageSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        bgImageControls.style.display = 'none';
                    }
                    scheduleUpdate(50);
                });
            }
            
            // Pattern Toggle (with auto-selection)
            const patternCheckbox = document.getElementById('pattern_enabled');
            const patternControls = document.getElementById('pattern_controls');
            const patternSelect = document.querySelector('[name="pattern_overlay"]');
            
            if (patternCheckbox && patternControls) {
                patternCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        patternControls.style.display = 'block';
                        // Auto-select first pattern if available
                        if (patternSelect && patternSelect.options.length > 0) {
                            patternSelect.selectedIndex = 0;
                            patternSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        patternControls.style.display = 'none';
                    }
                    scheduleUpdate(50);
                });
            }
            
            // Text Effects Toggles
            setupToggleControl('text_stroke_enabled', 'stroke_controls', null);
            setupToggleControl('text_box_enabled', 'background_box_controls', null);
        }

        // Utility functions
        function clamp(val, min, max) { 
            return Math.max(min, Math.min(max, val)); 
        }

        // XY Slider functionality for text positioning
        function updateXYDotFromInputs() {
            const xInput = document.getElementById('text_x_offset');
            const yInput = document.getElementById('text_y_offset');
            const dot = document.getElementById('xy-dot');
            
            if (xInput && yInput && dot) {
                const x = parseInt(xInput.value) || 0;
                const y = parseInt(yInput.value) || 0;
                const px = 60 + (x / 900) * 60;
                const py = 60 + (y / 900) * 60;
                dot.style.left = px + 'px';
                dot.style.top = py + 'px';
            }
        }

        function updateInputsFromXYDot(px, py) {
            const x = Math.round(((px - 60) / 60) * 900);
            const y = Math.round(((py - 60) / 60) * 900);
            const xInput = document.getElementById('text_x_offset');
            const yInput = document.getElementById('text_y_offset');
            
            if (xInput && yInput) {
                xInput.value = clamp(x, -900, 900);
                yInput.value = clamp(y, -900, 900);
            }
        }

        function setupXYSlider() {
            const slider = document.getElementById('xy-slider');
            const dot = document.getElementById('xy-dot');
            if (!slider || !dot) return;
            
            let dragging = false;
            
            dot.addEventListener('pointerdown', function(e) {
                dragging = true;
                dot.setPointerCapture(e.pointerId);
            });
            
            dot.addEventListener('pointerup', function(e) {
                dragging = false;
                dot.releasePointerCapture(e.pointerId);
            });
            
            dot.addEventListener('pointermove', function(e) {
                if (!dragging) return;
                const rect = slider.getBoundingClientRect();
                let px = clamp(e.clientX - rect.left, 0, 120);
                let py = clamp(e.clientY - rect.top, 0, 120);
                updateInputsFromXYDot(px, py);
                updateXYDotFromInputs();
                scheduleUpdate(50);
            });
            
            const xInput = document.getElementById('text_x_offset');
            const yInput = document.getElementById('text_y_offset');
            const resetBtn = document.getElementById('xy-reset');
            
            if (xInput) {
                xInput.addEventListener('input', function() {
                    updateXYDotFromInputs();
                    scheduleUpdate(50);
                });
            }
            
            if (yInput) {
                yInput.addEventListener('input', function() {
                    updateXYDotFromInputs();
                    scheduleUpdate(50);
                });
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (xInput) xInput.value = 0;
                    if (yInput) yInput.value = 0;
                    updateXYDotFromInputs();
                    scheduleUpdate(50);
                });
            }
            
            updateXYDotFromInputs();
        }

        // Slider and input synchronization
        function setupAllSliders() {
            document.querySelectorAll('.slider-group').forEach(function(group) {
                const range = group.querySelector('input[type="range"]');
                const number = group.querySelector('input[type="number"]');
                const reset = group.querySelector('.reset-btn');
                const defaultVal = group.dataset.default;
                
                if (range && number) {
                    range.addEventListener('input', function() {
                        number.value = range.value;
                        scheduleUpdate(50);
                    });
                    number.addEventListener('input', function() {
                        range.value = number.value;
                        scheduleUpdate(150);
                    });
                }
                
                if (reset && range && number && defaultVal) {
                    reset.addEventListener('click', function() {
                        range.value = defaultVal;
                        number.value = defaultVal;
                        scheduleUpdate(50);
                    });
                }
            });
        }

        // Universal input event listeners
        function setupAllInputs() {
            document.querySelectorAll('form input, form select, form textarea').forEach(function(input) {
                if (['range', 'number', 'color', 'text'].includes(input.type) || 
                    input.tagName === 'SELECT' || input.tagName === 'TEXTAREA') {
                    input.addEventListener('input', function() {
                        scheduleUpdate(50);
                    });
                }
                if (input.type === 'radio' || input.type === 'checkbox') {
                    input.addEventListener('change', function() {
                        scheduleUpdate(50);
                    });
                }
            });
        }



        // Update scheduling and preview management
        let updateTimeout;
        let currentRequest = null;
        const responseCache = new Map();

        function getActiveForm() {
            return document.getElementById('settings-form');
        }

        function getActivePreviewElements() {
            return {
                img: document.getElementById('preview-img'),
                text: document.getElementById('preview-text'),
                spinner: document.getElementById('preview-spinner')
            };
        }

        function scheduleUpdate(delay = 0) {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                updatePreview();
                updateFilenames();
            }, delay);
        }

        function createRequestKey(formData) {
            const entries = Array.from(formData.entries()).sort(([a], [b]) => a.localeCompare(b));
            return entries.map(([key, value]) => `${key}=${value}`).join('&');
        }

        // Preview update functionality
        async function updatePreview() {
            try {
                const form = getActiveForm();
                const preview = getActivePreviewElements();

                if (!form || !preview.img || !preview.text) return;

                const formData = new FormData(form);
                
                // Use the actual starting number if batch mode is enabled
                const batchMode = document.getElementById('batch_mode');
                const startNumber = document.getElementById('start_number');
                if (batchMode && batchMode.checked && startNumber) {
                    formData.set('start_number', startNumber.value);
                } else {
                    formData.set('start_number', 1);
                }

                const requestKey = createRequestKey(formData);

                // Check cache
                if (responseCache.has(requestKey)) {
                    const cachedData = responseCache.get(requestKey);
                    if (Date.now() - cachedData.timestamp < 5000) {
                        updatePreviewImage(cachedData.data);
                        return;
                    } else {
                        responseCache.delete(requestKey);
                    }
                }

                // Cancel previous request
                if (currentRequest) {
                    currentRequest.abort();
                }

                const controller = new AbortController();
                currentRequest = controller;

                if (preview.spinner) {
                    preview.spinner.classList.add('active');
                }

                const response = await fetch('/preview', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                const data = await response.json();

                if (preview.spinner) {
                    preview.spinner.classList.remove('active');
                }

                if (data.success) {
                    responseCache.set(requestKey, {
                        data: data,
                        timestamp: Date.now()
                    });

                    if (responseCache.size > 50) {
                        const oldestKey = responseCache.keys().next().value;
                        responseCache.delete(oldestKey);
                    }

                    updatePreviewImage(data);
                } else {
                    preview.text.textContent = `Error: ${data.error}`;
                    preview.text.style.display = 'block';
                    preview.img.style.display = 'none';
                }

                currentRequest = null;

            } catch (error) {
                const preview = getActivePreviewElements();
                if (error.name !== 'AbortError') {
                    if (preview.spinner) {
                        preview.spinner.classList.remove('active');
                    }
                    preview.text.textContent = `Error: ${error.message}`;
                    preview.text.style.display = 'block';
                    preview.img.style.display = 'none';
                }
            }
        }

        function updatePreviewImage(data) {
            const preview = getActivePreviewElements();
            if (preview.img && preview.text) {
                preview.img.src = data.image;
                preview.img.style.display = 'block';
                preview.text.style.display = 'none';

                // Draw to hidden canvas for pixel sampling
                const canvas = document.getElementById('preview-canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                const img = new window.Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    // After drawing, update the contrast checker with sampled color
                    updateContrastCheckerWithSampledBg();
                };
                img.src = data.image;

                // Sync draggable overlay
                setTimeout(() => {
                    const overlay = document.getElementById('draggable-overlay');
                    if (overlay) {
                        const previewContainer = document.getElementById('preview-container');
                        const img = document.getElementById('preview-img');
                        if (previewContainer && img) {
                            const containerRect = previewContainer.getBoundingClientRect();
                            const imgRect = img.getBoundingClientRect();
                            overlay.style.display = 'block';
                            overlay.style.left = (imgRect.left - containerRect.left) + 'px';
                            overlay.style.top = (imgRect.top - containerRect.top) + 'px';
                            overlay.style.width = imgRect.width + 'px';
                            overlay.style.height = imgRect.height + 'px';
                        }
                    }
                }, 100);
            }
        }

        // Filename preview for batch mode
        function updateFilenames() {
            const batchMode = document.getElementById('batch_mode');
            if (!batchMode || !batchMode.checked) return;

            const fileBase = document.getElementById('filename_base');
            const startNum = document.getElementById('start_number');
            const count = document.getElementById('batch_count');
            const previewEl = document.getElementById('filename-preview');
            const textInput = document.getElementById('text');

            if (!fileBase || !startNum || !count || !previewEl || !textInput) return;

            const startNumber = parseInt(startNum.value) || 1;
            const batchCount = parseInt(count.value) || 1;
            const textTemplate = textInput.value;
            const fileBaseValue = fileBase.value;

            let preview = 'Files that will be generated:\n';
            const showCount = Math.min(batchCount, 10);

            for (let i = 0; i < showCount; i++) {
                const number = startNumber + i;
                // Find the number used in the text (replace ^ with number)
                const textForImage = textTemplate.replace(/\^/g, number);
                // Filename: FileName_number.png
                preview += `${fileBaseValue}_${number}.png\n`;
            }

            if (batchCount > 10) {
                preview += `... and ${batchCount - 10} more files`;
            }

            previewEl.textContent = preview;
        }

        // Download functions
        async function downloadThumbnail() {
            const btn = document.getElementById('download-btn');
            if (!btn) return;
            
            const originalText = btn.textContent;
            const batchMode = document.getElementById('batch_mode');

            try {
                btn.textContent = batchMode && batchMode.checked ? 'Generating...' : 'Downloading...';
                btn.disabled = true;

                const formData = new FormData(document.getElementById('settings-form'));
                
                // Add batch parameters manually since they're outside the form
                const filenameBase = document.getElementById('filename_base');
                const startNumber = document.getElementById('start_number');
                const batchCount = document.getElementById('batch_count');
                const batchModeCheckbox = document.getElementById('batch_mode');
                
                if (filenameBase) formData.set('filename_base', filenameBase.value);
                if (startNumber) formData.set('start_number', startNumber.value);
                if (batchCount) formData.set('batch_count', batchCount.value);
                if (batchModeCheckbox) formData.set('batch_mode', batchModeCheckbox.checked ? 'on' : 'off');
                
                // Debug: log what's being sent
                console.log('Batch mode:', batchModeCheckbox?.checked);
                console.log('Start number:', startNumber?.value);
                console.log('Batch count:', batchCount?.value);
                console.log('Filename base:', filenameBase?.value);

                const endpoint = batchMode && batchMode.checked ? '/generate' : '/individual';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    if (batchMode && batchMode.checked) {
                        a.download = `thumbnails_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.zip`;
                    } else {
                        a.download = `thumbnail_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.png`;
                    }
                    
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Download failed');
                }
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            } finally {
                btn.textContent = batchMode && batchMode.checked ? 'Generate & Download ZIP' : 'Download PNG';
                btn.disabled = false;
            }
        }

        // Contrast checker logic (WebAIM/WCAG)
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            if (hex.length === 3) {
                hex = hex.split('').map(x => x + x).join('');
            }
            const num = parseInt(hex, 16);
            return [
                (num >> 16) & 255,
                (num >> 8) & 255,
                num & 255
            ];
        }

        function luminance([r, g, b]) {
            const a = [r, g, b].map(function (v) {
                v /= 255;
                return v <= 0.03928
                    ? v / 12.92
                    : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
        }

        function contrastRatio(hex1, hex2) {
            const lum1 = luminance(hexToRgb(hex1));
            const lum2 = luminance(hexToRgb(hex2));
            const brightest = Math.max(lum1, lum2);
            const darkest = Math.min(lum1, lum2);
            return ((brightest + 0.05) / (darkest + 0.05));
        }

        function updateContrastChecker() {
            const textHex = document.querySelector('input[name="text_color"]').value || '#ffffff';
            const bgHex = document.querySelector('input[name="background_color"]').value || '#23272b';
            
            // Update swatches and hex
            document.getElementById('contrast-text-swatch').style.background = textHex;
            document.getElementById('contrast-text-hex').textContent = textHex.toUpperCase();
            document.getElementById('contrast-bg-swatch').style.background = bgHex;
            document.getElementById('contrast-bg-hex').textContent = bgHex.toUpperCase();
            
            // Calculate ratio
            let ratio = contrastRatio(textHex, bgHex);
            let ratioStr = ratio.toFixed(2) + ':1';
            document.getElementById('contrast-ratio').textContent = ratioStr;
            
            // WCAG pass/fail
            let status = '';
            // Normal text
            status += `<span>Normal Text: <b style="color:${ratio >= 4.5 ? '#4A773C' : '#D73F09'}">${ratio >= 4.5 ? 'AA Pass' : 'AA Fail'}</b> / <b style="color:${ratio >= 7 ? '#4A773C' : '#D73F09'}">${ratio >= 7 ? 'AAA Pass' : 'AAA Fail'}</b></span><br>`;
            // Large text
            status += `<span>Large Text: <b style="color:${ratio >= 3 ? '#4A773C' : '#D73F09'}">${ratio >= 3 ? 'AA Pass' : 'AA Fail'}</b> / <b style="color:${ratio >= 4.5 ? '#4A773C' : '#D73F09'}">${ratio >= 4.5 ? 'AAA Pass' : 'AAA Fail'}</b></span><br>`;
            // UI components/graphics
            status += `<span>UI/Graphics: <b style="color:${ratio >= 3 ? '#4A773C' : '#D73F09'}">${ratio >= 3 ? 'AA Pass' : 'AA Fail'}</b></span>`;
            document.getElementById('contrast-status').innerHTML = status;
        }

        function updateContrastCheckerWithSampledBg() {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            // Get text and font settings from form
            const text = document.getElementById('text').value;
            const fontSize = parseInt(document.querySelector('input[name="font_size"]').value) || 100;
            const fontName = document.querySelector('select[name="font_name"]').value || 'Arial';
            const xOffset = parseInt(document.getElementById('text_x_offset').value) || 0;
            const yOffset = parseInt(document.getElementById('text_y_offset').value) || 0;
            const lineSpacing = (parseInt(document.querySelector('input[name="line_spacing_factor"]').value) || 30) / 100 * fontSize;

            // Calculate text position
            const lines = text.split('\n');
            let textWidth = 0;
            const tempCtx = canvas.getContext('2d');
            tempCtx.font = `${fontSize}px \"${fontName}\"`;
            lines.forEach(line => {
                textWidth = Math.max(textWidth, tempCtx.measureText(line).width);
            });
            const totalHeight = lines.length * (fontSize + lineSpacing) - lineSpacing;

            let x = (canvas.width - textWidth) / 2 + xOffset;
            let y = (canvas.height - totalHeight) / 2 + yOffset;

            // Sample multiple points across the text area to find worst case
            const samplePoints = [];
            const stepX = Math.max(1, Math.floor(textWidth / 5)); // Sample 5 points horizontally
            const stepY = Math.max(1, Math.floor(totalHeight / 3)); // Sample 3 points vertically
            
            for (let sx = 0; sx <= textWidth; sx += stepX) {
                for (let sy = 0; sy <= totalHeight; sy += stepY) {
                    const sampleX = Math.round(x + sx);
                    const sampleY = Math.round(y + sy);
                    
                    // Make sure we're within canvas bounds
                    if (sampleX >= 0 && sampleX < canvas.width && sampleY >= 0 && sampleY < canvas.height) {
                        samplePoints.push({ x: sampleX, y: sampleY });
                    }
                }
            }
            
            // Find the worst contrast ratio among all sample points
            let worstRatio = Infinity;
            let worstBgColor = { r: 0, g: 0, b: 0 };
            
            // Get text color from input
            const textHex = document.querySelector('input[name="text_color"]').value || '#ffffff';
            
            for (const point of samplePoints) {
                const pixelData = ctx.getImageData(point.x, point.y, 1, 1);
                const bgR = pixelData.data[0];
                const bgG = pixelData.data[1];
                const bgB = pixelData.data[2];
                
                // Skip white pixels (text) - only sample background colors
                if (bgR > 240 && bgG > 240 && bgB > 240) {
                    continue; // Skip white text pixels
                }
                
                const ratio = contrastRatio(textHex, rgbToHex(bgR, bgG, bgB));
                
                if (ratio < worstRatio) {
                    worstRatio = ratio;
                    worstBgColor = { r: bgR, g: bgG, b: bgB };
                }
            }
            
            // Use the worst case
            const bgHex = rgbToHex(worstBgColor.r, worstBgColor.g, worstBgColor.b);
            const ratio = worstRatio;
            
            // Update swatches and hex
            document.getElementById('contrast-text-swatch').style.background = textHex;
            document.getElementById('contrast-text-hex').textContent = textHex.toUpperCase();
            document.getElementById('contrast-bg-swatch').style.background = bgHex;
            document.getElementById('contrast-bg-hex').textContent = bgHex.toUpperCase();

            // Display contrast ratio
            let ratioStr = ratio.toFixed(2) + ':1';
            document.getElementById('contrast-ratio').textContent = ratioStr;

            // WCAG pass/fail
            let status = '';
            status += `<span>Normal Text: <b style=\"color:${ratio >= 4.5 ? '#4A773C' : '#D73F09'}\">${ratio >= 4.5 ? 'AA Pass' : 'AA Fail'}</b> / <b style=\"color:${ratio >= 7 ? '#4A773C' : '#D73F09'}\">${ratio >= 7 ? 'AAA Pass' : 'AAA Fail'}</b></span><br>`;
            status += `<span>Large Text: <b style=\"color:${ratio >= 3 ? '#4A773C' : '#D73F09'}\">${ratio >= 3 ? 'AA Pass' : 'AA Fail'}</b> / <b style=\"color:${ratio >= 4.5 ? '#4A773C' : '#D73F09'}\">${ratio >= 4.5 ? 'AAA Pass' : 'AAA Fail'}</b></span><br>`;
            status += `<span>UI/Graphics: <b style=\"color:${ratio >= 3 ? '#4A773C' : '#D73F09'}\">${ratio >= 3 ? 'AA Pass' : 'AA Fail'}</b></span>`;
            document.getElementById('contrast-status').innerHTML = status;
        }

        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupXYSlider();
            setupAllSliders();
            setupAllInputs();
            
            // Setup show/hide functionality for background and pattern controls
            setupToggleControls();
            
            // Setup batch mode toggle
            const batchMode = document.getElementById('batch_mode');
            const batchControls = document.getElementById('batch_controls');
            const downloadBtn = document.getElementById('download-btn');
            
            if (batchMode && batchControls) {
                batchMode.addEventListener('change', function() {
                    if (this.checked) {
                        batchControls.style.display = 'block';
                        if (downloadBtn) downloadBtn.textContent = 'Generate & Download ZIP';
                    } else {
                        batchControls.style.display = 'none';
                        if (downloadBtn) downloadBtn.textContent = 'Download PNG';
                    }
                    updateFilenames();
                    scheduleUpdate(50); // Update preview when batch mode is toggled
                });
            }
            
            // Setup event listeners for form
            const form = document.getElementById('settings-form');
            if (form) {
                form.addEventListener('change', () => scheduleUpdate(50));
                form.addEventListener('input', () => scheduleUpdate(50));
            }

            // Batch controls
            const startNumber = document.getElementById('start_number');
            const batchCount = document.getElementById('batch_count');
            const filenameBase = document.getElementById('filename_base');
            
            if (startNumber) {
                startNumber.addEventListener('input', () => {
                    updateFilenames();
                    scheduleUpdate(50); // Also update preview when starting number changes
                });
            }
            
            if (batchCount) {
                batchCount.addEventListener('input', () => {
                    updateFilenames();
                });
            }
            
            if (filenameBase) {
                filenameBase.addEventListener('input', () => {
                    updateFilenames();
                });
            }
            
            // Also update filenames when text changes (for ^ replacement)
            const textInput = document.getElementById('text');
            if (textInput) {
                textInput.addEventListener('input', () => {
                    updateFilenames();
                });
            }

            // Button events
            if (downloadBtn) downloadBtn.addEventListener('click', downloadThumbnail);

            // Update contrast checker on color changes
            const textColorInput = document.querySelector('input[name="text_color"]');
            const bgColorInput = document.querySelector('input[name="background_color"]');
            if (textColorInput) textColorInput.addEventListener('input', updateContrastChecker);
            if (bgColorInput) bgColorInput.addEventListener('input', updateContrastChecker);

            // Setup comprehensive color selection system for text color
            const textBrandedDropdownHeader = document.getElementById('text-branded-dropdown-header');
            const textBrandedOptions = document.getElementById('text-branded-options');
            const textBrandedText = document.getElementById('text-branded-text');
            const textHexInput = document.getElementById('text-hex-input');
            
            // Brand color mapping for reverse lookup
            const brandColors = {
                '#FFFFFF': 'Bucktooth White',
                '#000000': 'Paddletail Black', 
                '#D73F09': 'Beaver Orange',
                '#4A773C': 'Pine Stand',
                '#00859B': 'High Tide',
                '#FFB500': 'Luminance',
                '#006A8E': 'Stratosphere',
                '#C4D6A4': 'Reindeer Moss',
                '#B8DDE1': 'Seafoam',
                '#FDD26E': 'Candela',
                '#C6DAE7': 'Moondust',
                '#AA9D2E': 'Hop Bine',
                '#0D5257': 'Rogue Wave',
                '#D3832B': 'Solar Flare',
                '#003B5C': 'Star Canvas',
                '#B7A99A': 'Till',
                '#A7ACA2': 'Coastline',
                '#7A6855': 'High Desert',
                '#8E9089': 'Crater'
            };

            function updateTextColorFromSource(source, color) {
                if (!color) return;
                
                // Normalize color to uppercase
                color = color.toUpperCase();
                
                // Update color picker
                if (textColorInput) {
                    textColorInput.value = color;
                    textColorInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Update hex input
                if (textHexInput && source !== 'hex') {
                    textHexInput.value = color;
                }
                
                // Update custom dropdown
                if (source !== 'dropdown') {
                    const brandName = brandColors[color];
                    if (brandName) {
                        // Find and select the matching branded color
                        const option = textBrandedOptions.querySelector(`[data-color="${color}"]`);
                        if (option) {
                            textBrandedText.textContent = brandName;
                            // Update selected state
                            textBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                            option.classList.add('selected');
                        }
                    } else {
                        // Set to custom if not a branded color
                        textBrandedText.textContent = 'Custom';
                        // Update selected state
                        textBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                        textBrandedOptions.querySelector('[data-color="custom"]').classList.add('selected');
                    }
                }
                
                updateContrastChecker();
            }

            // Custom dropdown toggle
            if (textBrandedDropdownHeader) {
                textBrandedDropdownHeader.addEventListener('click', function() {
                    const isOpen = textBrandedOptions.style.display === 'block';
                    if (isOpen) {
                        textBrandedOptions.style.display = 'none';
                        this.classList.remove('active');
                    } else {
                        // Position the dropdown
                        const rect = this.getBoundingClientRect();
                        textBrandedOptions.style.left = rect.left + 'px';
                        textBrandedOptions.style.top = (rect.bottom + 2) + 'px';
                        textBrandedOptions.style.display = 'block';
                        this.classList.add('active');
                    }
                });
            }

            // Custom dropdown option selection
            if (textBrandedOptions) {
                textBrandedOptions.addEventListener('click', function(e) {
                    const option = e.target.closest('.dropdown-option');
                    if (option) {
                        const color = option.dataset.color;
                        if (color && color !== 'custom') {
                            updateTextColorFromSource('dropdown', color);
                        }
                        // Close dropdown
                        textBrandedOptions.style.display = 'none';
                        textBrandedDropdownHeader.classList.remove('active');
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-dropdown')) {
                    textBrandedOptions.style.display = 'none';
                    textBrandedDropdownHeader.classList.remove('active');
                }
            });

            // Hex input change handler
            if (textHexInput) {
                textHexInput.addEventListener('input', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateTextColorFromSource('hex', color);
                    }
                });
                
                textHexInput.addEventListener('blur', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                        this.value = color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateTextColorFromSource('hex', color);
                    }
                });
            }

            // Color picker change handler
            if (textColorInput) {
                textColorInput.addEventListener('input', function() {
                    updateTextColorFromSource('picker', this.value);
                });
            }

            // Setup comprehensive color selection system for background color
            const bgBrandedDropdownHeader = document.getElementById('bg-branded-dropdown-header');
            const bgBrandedOptions = document.getElementById('bg-branded-options');
            const bgBrandedText = document.getElementById('bg-branded-text');
            const bgHexInput = document.getElementById('bg-hex-input');

            function updateBgColorFromSource(source, color) {
                if (!color) return;
                
                // Normalize color to uppercase
                color = color.toUpperCase();
                
                // Update color picker
                if (bgColorInput) {
                    bgColorInput.value = color;
                    bgColorInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Update hex input
                if (bgHexInput && source !== 'hex') {
                    bgHexInput.value = color;
                }
                
                // Update custom dropdown
                if (source !== 'dropdown') {
                    const brandName = brandColors[color];
                    if (brandName) {
                        // Find and select the matching branded color
                        const option = bgBrandedOptions.querySelector(`[data-color="${color}"]`);
                        if (option) {
                            bgBrandedText.textContent = brandName;
                            // Update selected state
                            bgBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                            option.classList.add('selected');
                        }
                    } else {
                        // Set to custom if not a branded color
                        bgBrandedText.textContent = 'Custom';
                        // Update selected state
                        bgBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                        bgBrandedOptions.querySelector('[data-color="custom"]').classList.add('selected');
                    }
                }
                
                // Don't call updateContrastChecker here to avoid circular dependency
            }

            // Background dropdown toggle
            if (bgBrandedDropdownHeader) {
                bgBrandedDropdownHeader.addEventListener('click', function() {
                    const isOpen = bgBrandedOptions.style.display === 'block';
                    if (isOpen) {
                        bgBrandedOptions.style.display = 'none';
                        this.classList.remove('active');
                    } else {
                        // Position the dropdown
                        const rect = this.getBoundingClientRect();
                        bgBrandedOptions.style.left = rect.left + 'px';
                        bgBrandedOptions.style.top = (rect.bottom + 2) + 'px';
                        bgBrandedOptions.style.display = 'block';
                        this.classList.add('active');
                    }
                });
            }

            // Background dropdown option selection
            if (bgBrandedOptions) {
                bgBrandedOptions.addEventListener('click', function(e) {
                    const option = e.target.closest('.dropdown-option');
                    if (option) {
                        const color = option.dataset.color;
                        if (color && color !== 'custom') {
                            updateBgColorFromSource('dropdown', color);
                        }
                        // Close dropdown
                        bgBrandedOptions.style.display = 'none';
                        bgBrandedDropdownHeader.classList.remove('active');
                    }
                });
            }

            // Background hex input change handler
            if (bgHexInput) {
                bgHexInput.addEventListener('input', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateBgColorFromSource('hex', color);
                    }
                });
                
                bgHexInput.addEventListener('blur', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                        this.value = color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateBgColorFromSource('hex', color);
                    }
                });
            }

            // Background color picker change handler
            if (bgColorInput) {
                bgColorInput.addEventListener('input', function() {
                    updateBgColorFromSource('picker', this.value);
                });
            }

            // Setup comprehensive color selection system for stroke color
            const strokeBrandedDropdownHeader = document.getElementById('stroke-branded-dropdown-header');
            const strokeBrandedOptions = document.getElementById('stroke-branded-options');
            const strokeBrandedText = document.getElementById('stroke-branded-text');
            const strokeHexInput = document.getElementById('stroke-hex-input');
            const strokeColorInput = document.querySelector('input[name="text_stroke_color"]');

            function updateStrokeColorFromSource(source, color) {
                if (!color) return;
                
                // Normalize color to uppercase
                color = color.toUpperCase();
                
                // Update color picker
                if (strokeColorInput) {
                    strokeColorInput.value = color;
                    strokeColorInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Update hex input
                if (strokeHexInput && source !== 'hex') {
                    strokeHexInput.value = color;
                }
                
                // Update custom dropdown
                if (source !== 'dropdown') {
                    const brandName = brandColors[color];
                    if (brandName) {
                        // Find and select the matching branded color
                        const option = strokeBrandedOptions.querySelector(`[data-color="${color}"]`);
                        if (option) {
                            strokeBrandedText.textContent = brandName;
                            // Update selected state
                            strokeBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                            option.classList.add('selected');
                        }
                    } else {
                        // Set to custom if not a branded color
                        strokeBrandedText.textContent = 'Custom';
                        // Update selected state
                        strokeBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                        strokeBrandedOptions.querySelector('[data-color="custom"]').classList.add('selected');
                    }
                }
                
                updateContrastChecker();
            }

            // Stroke dropdown toggle
            if (strokeBrandedDropdownHeader) {
                strokeBrandedDropdownHeader.addEventListener('click', function() {
                    const isOpen = strokeBrandedOptions.style.display === 'block';
                    if (isOpen) {
                        strokeBrandedOptions.style.display = 'none';
                        this.classList.remove('active');
                    } else {
                        // Position the dropdown
                        const rect = this.getBoundingClientRect();
                        strokeBrandedOptions.style.left = rect.left + 'px';
                        strokeBrandedOptions.style.top = (rect.bottom + 2) + 'px';
                        strokeBrandedOptions.style.display = 'block';
                        this.classList.add('active');
                    }
                });
            }

            // Stroke dropdown option selection
            if (strokeBrandedOptions) {
                strokeBrandedOptions.addEventListener('click', function(e) {
                    const option = e.target.closest('.dropdown-option');
                    if (option) {
                        const color = option.dataset.color;
                        if (color && color !== 'custom') {
                            updateStrokeColorFromSource('dropdown', color);
                        }
                        // Close dropdown
                        strokeBrandedOptions.style.display = 'none';
                        strokeBrandedDropdownHeader.classList.remove('active');
                    }
                });
            }

            // Stroke hex input change handler
            if (strokeHexInput) {
                strokeHexInput.addEventListener('input', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateStrokeColorFromSource('hex', color);
                    }
                });
                
                strokeHexInput.addEventListener('blur', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                        this.value = color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateStrokeColorFromSource('hex', color);
                    }
                });
            }

            // Stroke color picker change handler
            if (strokeColorInput) {
                strokeColorInput.addEventListener('input', function() {
                    updateStrokeColorFromSource('picker', this.value);
                });
            }

            // Setup comprehensive color selection system for box color
            const boxBrandedDropdownHeader = document.getElementById('box-branded-dropdown-header');
            const boxBrandedOptions = document.getElementById('box-branded-options');
            const boxBrandedText = document.getElementById('box-branded-text');
            const boxHexInput = document.getElementById('box-hex-input');
            const boxColorInput = document.querySelector('input[name="text_box_color"]');

            function updateBoxColorFromSource(source, color) {
                if (!color) return;
                
                // Normalize color to uppercase
                color = color.toUpperCase();
                
                // Update color picker
                if (boxColorInput) {
                    boxColorInput.value = color;
                    boxColorInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Update hex input
                if (boxHexInput && source !== 'hex') {
                    boxHexInput.value = color;
                }
                
                // Update custom dropdown
                if (source !== 'dropdown') {
                    const brandName = brandColors[color];
                    if (brandName) {
                        // Find and select the matching branded color
                        const option = boxBrandedOptions.querySelector(`[data-color="${color}"]`);
                        if (option) {
                            boxBrandedText.textContent = brandName;
                            // Update selected state
                            boxBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                            option.classList.add('selected');
                        }
                    } else {
                        // Set to custom if not a branded color
                        boxBrandedText.textContent = 'Custom';
                        // Update selected state
                        boxBrandedOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                        boxBrandedOptions.querySelector('[data-color="custom"]').classList.add('selected');
                    }
                }
                
                updateContrastChecker();
            }

            // Box dropdown toggle
            if (boxBrandedDropdownHeader) {
                boxBrandedDropdownHeader.addEventListener('click', function() {
                    const isOpen = boxBrandedOptions.style.display === 'block';
                    if (isOpen) {
                        boxBrandedOptions.style.display = 'none';
                        this.classList.remove('active');
                    } else {
                        // Position the dropdown
                        const rect = this.getBoundingClientRect();
                        boxBrandedOptions.style.left = rect.left + 'px';
                        boxBrandedOptions.style.top = (rect.bottom + 2) + 'px';
                        boxBrandedOptions.style.display = 'block';
                        this.classList.add('active');
                    }
                });
            }

            // Box dropdown option selection
            if (boxBrandedOptions) {
                boxBrandedOptions.addEventListener('click', function(e) {
                    const option = e.target.closest('.dropdown-option');
                    if (option) {
                        const color = option.dataset.color;
                        if (color && color !== 'custom') {
                            updateBoxColorFromSource('dropdown', color);
                        }
                        // Close dropdown
                        boxBrandedOptions.style.display = 'none';
                        boxBrandedDropdownHeader.classList.remove('active');
                    }
                });
            }

            // Box hex input change handler
            if (boxHexInput) {
                boxHexInput.addEventListener('input', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateBoxColorFromSource('hex', color);
                    }
                });
                
                boxHexInput.addEventListener('blur', function() {
                    let color = this.value.trim();
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                        this.value = color;
                    }
                    if (color && /^#[0-9A-F]{6}$/i.test(color)) {
                        updateBoxColorFromSource('hex', color);
                    }
                });
            }

            // Box color picker change handler
            if (boxColorInput) {
                boxColorInput.addEventListener('input', function() {
                    updateBoxColorFromSource('picker', this.value);
                });
            }

            // Initial updates
            scheduleUpdate(0);
            updateFilenames();
            updateContrastChecker();
        });

        // --- Undo/Redo and Reset All Implementation ---
        const form = document.getElementById('settings-form');
        const resetAllBtn = document.getElementById('reset-all-btn');
        let undoStack = [];
        let isRestoring = false;

        // Store default values for reset
        const defaultValues = {};
        if (form) {
            Array.from(form.elements).forEach(el => {
                if (el.name) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        defaultValues[el.name] = el.checked;
                    } else {
                        defaultValues[el.name] = el.value;
                    }
                }
            });
        }

        function getFormSnapshot() {
            const snapshot = {};
            Array.from(form.elements).forEach(el => {
                if (el.name) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        snapshot[el.name] = el.checked;
                    } else {
                        snapshot[el.name] = el.value;
                    }
                }
            });
            return snapshot;
        }

        function setFormSnapshot(snapshot) {
            isRestoring = true;
            Array.from(form.elements).forEach(el => {
                if (el.name && snapshot.hasOwnProperty(el.name)) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = snapshot[el.name];
                    } else {
                        el.value = snapshot[el.name];
                    }
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            isRestoring = false;
        }

        // Save snapshot on every change
        if (form) {
            form.addEventListener('input', function(e) {
                if (!isRestoring) {
                    undoStack.push(getFormSnapshot());
                    if (undoStack.length > 100) undoStack.shift();
                }
            }, true);
            form.addEventListener('change', function(e) {
                if (!isRestoring) {
                    undoStack.push(getFormSnapshot());
                    if (undoStack.length > 100) undoStack.shift();
                }
            }, true);
        }

        // Undo with Ctrl+Z or Cmd+Z
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && undoStack.length > 0) {
                e.preventDefault();
                const last = undoStack.pop();
                if (last) setFormSnapshot(last);
            }
        });

        // Reset All button
        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', function() {
                setFormSnapshot(defaultValues);
                undoStack = [];
            });
        }

        function getAverageColor(ctx, x, y, width, height) {
            const imageData = ctx.getImageData(x, y, width, height);
            const data = imageData.data;
            let r = 0, g = 0, b = 0, count = 0;
            for (let i = 0; i < data.length; i += 4) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
                count++;
            }
            return {
                r: Math.round(r / count),
                g: Math.round(g / count),
                b: Math.round(b / count)
            };
        }
    </script>
    <canvas id="preview-canvas" width="1280" height="720" style="display:none;"></canvas>
    <canvas id="text-mask-canvas" width="1280" height="720" style="display:none;"></canvas>
</body>
</html>